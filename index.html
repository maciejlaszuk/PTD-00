<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PTD-00 System - AutoDetect</title>

    <!-- 1. Silnik Mobile (Google) -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <!-- 2. Silnik VR/MR (A-Frame) -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <style>
        /* RESET I FULLSCREEN */
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background-color: #202020; /* Ciemne t≈Ço dla desktopu/loadingu */
            overflow: hidden; 
        }

        /* KONTENERY */
        #mobile-container {
            width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 10;
            display: none; /* Domy≈õlnie ukryte, skrypt w≈ÇƒÖczy odpowiedni */
            background-color: #f5f5f5;
        }

        #quest-container {
            width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 20;
            display: none; /* Domy≈õlnie ukryte */
            background: transparent; /* Kluczowe dla Queata w trybie 2D */
        }

        /* STYLIZACJA MODEL-VIEWER (MOBILE) */
        model-viewer { 
            width: 100%; height: 100%; 
            --poster-color: transparent;
        }

        /* PRZYCISK STARTOWY QUEST */
        .quest-start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.8); color: white;
        }

        .btn-quest-start {
            padding: 20px 40px; font-size: 24px; border-radius: 50px;
            background: #8e44ad; color: white; border: 2px solid white;
            cursor: pointer; font-weight: bold; margin-top: 20px;
            box-shadow: 0 0 20px rgba(142, 68, 173, 0.5);
        }

        .info-text { font-family: monospace; font-size: 1.2em; text-align: center; max-width: 80%; }
    </style>

    <!-- LOGIKA DETEKCJI I CHWYTANIA -->
    <script>
        // 1. SKRYPT CHWYTANIA (Quest 3)
        AFRAME.registerComponent('raycast-grab', {
            init: function () {
                this.grabbedEl = null;
                this.raycaster = this.el.components.raycaster;

                // Nas≈Çuch przycisku GRIP (boczny pod palcem ≈õrodkowym)
                this.el.addEventListener('gripdown', this.onGrab.bind(this));
                this.el.addEventListener('gripup', this.onRelease.bind(this));
            },
            onGrab: function () {
                // Sprawd≈∫ czy promie≈Ñ w co≈õ celuje
                const intersections = this.el.components.raycaster.intersectedEls;
                if (intersections.length > 0) {
                    // We≈∫ pierwszy trafiony obiekt
                    const hitEl = intersections[0];
                    
                    // Sprawd≈∫ czy to nasz silos (zabezpieczenie)
                    if (hitEl.classList.contains('clickable')) {
                        this.grabbedEl = hitEl;
                        // PARENTING: Przepnij silos do kontrolera
                        this.grabbedEl.object3D.attach(this.el.object3D);
                    }
                }
            },
            onRelease: function () {
                if (this.grabbedEl) {
                    // ODPINANIE: Przepnij z powrotem do sceny
                    this.el.sceneEl.object3D.attach(this.grabbedEl.object3D);
                    this.grabbedEl = null;
                }
            }
        });

        // 2. DETEKCJA URZƒÑDZENIA (Uruchamia siƒô po za≈Çadowaniu strony)
        window.addEventListener('load', () => {
            const userAgent = navigator.userAgent;
            const isQuest = userAgent.includes('Oculus') || userAgent.includes('Quest');

            if (isQuest) {
                // Tryb Quest: Poka≈º kontener VR, ukryj Mobile
                document.getElementById('quest-container').style.display = 'block';
                console.log("Wykryto Meta Quest 3");
            } else {
                // Tryb Mobile/Desktop: Poka≈º kontener Mobile
                document.getElementById('mobile-container').style.display = 'block';
                console.log("Wykryto Mobile/Desktop");
            }
        });

        // Funkcja wej≈õcia w VR (Quest)
        function enterMixedReality() {
            const scene = document.querySelector('a-scene');
            scene.enterVR(); // To uruchamia tryb immersyjny
        }
    </script>
</head>
<body>

    <!-- === WIDOK 1: MOBILE (iOS / Android) === -->
    <!-- Wy≈õwietla siƒô TYLKO na telefonach. Quest tego nie widzi. -->
    <div id="mobile-container">
        <model-viewer 
            src="PTD-00.glb" 
            ios-src="PTD-00.usdz" 
            ar 
            ar-modes="scene-viewer quick-look" 
            camera-controls 
            auto-rotate
            shadow-intensity="1">
            
            <button slot="ar-button" style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 12px 24px; background: #007bff; color: white; border-radius: 30px; border: none; font-weight: bold; font-size: 16px;">
                üì¶ Zobacz w AR
            </button>
        </model-viewer>
    </div>

    <!-- === WIDOK 2: QUEST 3 (Mixed Reality) === -->
    <!-- Wy≈õwietla siƒô TYLKO na goglach. Telefon tego nie widzi. -->
    <div id="quest-container">
        
        <!-- Ekran powitalny w przeglƒÖdarce gogli (2D) -->
        <div class="quest-start-overlay">
            <div class="info-text">Tryb In≈ºynierski: Meta Quest 3</div>
            <button class="btn-quest-start" onclick="enterMixedReality()">
                Wejd≈∫ w Mixed Reality
            </button>
            <p style="margin-top:10px; opacity: 0.7;">Po wej≈õciu: U≈ºyj bocznego przycisku (Grip), aby chwyciƒá i przesunƒÖƒá model.</p>
        </div>

        <!-- SCENA VR/AR -->
        <!-- background="color: transparent" -> TO USUWA BIA≈ÅE T≈ÅO -->
        <a-scene 
            embedded
            renderer="alpha: true; colorManagement: true; exposure: 1;"
            webxr="optionalFeatures: hit-test, local-floor; overlayElement: #quest-container"
            background="color: transparent">

            <a-assets>
                <a-asset-item id="silos-glb" src="PTD-00.glb"></a-asset-item>
            </a-assets>

            <!-- O≈öWIETLENIE SCENY (Dla kontrastu) -->
            <a-entity light="type: ambient; intensity: 1.0;"></a-entity>
            <a-entity light="type: directional; intensity: 1.5; castShadow: true;" position="-1 2 1"></a-entity>

            <!-- MODEL GL√ìWNY -->
            <!-- class="clickable" -> Oznacza, ≈ºe laser go widzi -->
            <!-- position="0 1 -1" -> 1 metr nad ziemiƒÖ, 1 metr przed TobƒÖ -->
            <!-- scale="0.5 0.5 0.5" -> Na start 50% skali (≈Çatwiej ogarnƒÖƒá w pokoju) -->
            <a-entity 
                id="main-model"
                class="clickable"
                gltf-model="#silos-glb" 
                position="0 1 -1" 
                scale="0.5 0.5 0.5"
                shadow="receive: true">
            </a-entity>

            <!-- RIG (GRACZ) -->
            <!-- Pozycja 0 0 0 -> Resetuje pozycjƒô do Twoich st√≥p w pokoju -->
            <a-entity id="rig" position="0 0 0">
                <!-- Kamera -->
                <a-camera position="0 0 0" look-controls="pointerLockEnabled: false"></a-camera>
                
                <!-- KONTROLERY (Prawy i Lewy) -->
                <!-- raycaster: far: 5 -> Laser siƒôga na 5 metr√≥w -->
                <!-- line: color: red -> ≈ªeby≈õ widzia≈Ç gdzie celujesz -->
                
                <a-entity 
                    id="rightHand"
                    oculus-touch-controls="hand: right"
                    laser-controls="hand: right"
                    raycaster="objects: .clickable; far: 5; showLine: true; lineColor: red; lineOpacity: 0.7"
                    raycast-grab>
                </a-entity>

                <a-entity 
                    id="leftHand"
                    oculus-touch-controls="hand: left"
                    laser-controls="hand: left"
                    raycaster="objects: .clickable; far: 5; showLine: true; lineColor: red; lineOpacity: 0.7"
                    raycast-grab>
                </a-entity>
            </a-entity>

        </a-scene>
    </div>

</body>
</html>
