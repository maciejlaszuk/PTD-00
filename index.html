<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PTD-00 Final Viewer</title>

    <!-- 1. Mobile Engine -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <!-- 2. Quest Engine -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <style>
        /* FIX: Wymuszenie pe≈Çnego ekranu dla wszystkich kontener√≥w */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #f0f0f0; }
        
        #mobile-view { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; display: block; }
        #quest-view { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 20; display: none; }

        /* Stylizacja Model-Viewer na pe≈Çny ekran */
        model-viewer { width: 100%; height: 100%; --poster-color: transparent; }

        /* Przyciski */
        .controls { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 100; pointer-events: none; }
        .btn { pointer-events: auto; padding: 12px 25px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 16px; font-family: sans-serif; }
        .btn-quest { background: #8e44ad; color: white; display: flex; align-items: center; gap: 8px; }
        .btn-exit { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); color: white; z-index: 1001; display: none; }

        /* Ukryj Quest na ma≈Çych ekranach */
        @media (max-width: 600px) { .btn-quest { display: none; } }
    </style>

    <!-- LOGIKA QUEST: Remote Grab (Chwyƒá gdziekolwiek, by ruszyƒá model) -->
    <script>
        AFRAME.registerComponent('remote-grab', {
            init: function () {
                this.grabbedEl = null;
                // Nas≈Çuchuj przycisku GRIP (boczny)
                this.el.addEventListener('gripdown', this.onGrab.bind(this));
                this.el.addEventListener('gripup', this.onRelease.bind(this));
            },
            onGrab: function () {
                // Znajd≈∫ model w scenie
                const model = document.querySelector('#target-model');
                if (model && !this.grabbedEl) {
                    this.grabbedEl = model;
                    // "Przyklej" model do kontrolera (zachowujƒÖc pozycjƒô w ≈õwiecie, ≈ºeby nie skaka≈Ç)
                    this.grabbedEl.object3D.attach(this.el.object3D);
                }
            },
            onRelease: function () {
                if (this.grabbedEl) {
                    // "Odczep" model - przywr√≥ƒá go do sceny
                    this.el.sceneEl.object3D.attach(this.grabbedEl.object3D);
                    this.grabbedEl = null;
                }
            }
        });

        function enterVRMode() {
            document.getElementById('mobile-view').style.display = 'none';
            document.getElementById('quest-view').style.display = 'block';
            document.querySelector('.btn-exit').style.display = 'block';
            
            const scene = document.querySelector('a-scene');
            if(scene.enterVR) scene.enterVR();
        }

        function exitVRMode() {
            const scene = document.querySelector('a-scene');
            if(scene.exitVR) scene.exitVR();
            
            document.getElementById('mobile-view').style.display = 'block';
            document.getElementById('quest-view').style.display = 'none';
            document.querySelector('.btn-exit').style.display = 'none';
        }
    </script>
</head>
<body>

    <!-- === SEKCJA 1: TELEFON (Android/iOS) === -->
    <div id="mobile-view">
        <model-viewer 
            src="PTD-00.glb" 
            ios-src="PTD-00.usdz" 
            ar 
            ar-modes="webxr scene-viewer quick-look" 
            camera-controls 
            auto-rotate
            shadow-intensity="1">
            
            <button slot="ar-button" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; background: #007bff; color: white; border-radius: 30px; border: none; font-weight: bold;">
                üì¶ AR (Telefon)
            </button>
        </model-viewer>

        <!-- Przycisk widoczny tylko na du≈ºych ekranach/Quest -->
        <div class="controls">
            <button class="btn btn-quest" onclick="enterVRMode()">
                <span>ü•Ω</span> Tryb Quest 3 (Mixed Reality)
            </button>
        </div>
    </div>

    <!-- === SEKCJA 2: QUEST 3 (Mixed Reality) === -->
    <div id="quest-view">
        <button class="btn btn-exit" onclick="exitVRMode()">‚ùå Zamknij</button>

        <!-- Scena A-Frame:
             background="color: transparent" -> KLUCZOWE dla Passthrough
             renderer="alpha: true" -> W≈ÇƒÖcza przezroczysto≈õƒá canvasa
        -->
        <a-scene 
            embedded
            webxr="optionalFeatures: hit-test, local-floor; overlayElement: #quest-view"
            renderer="alpha: true; colorManagement: true;"
            background="color: transparent">

            <a-assets>
                <a-asset-item id="silos-asset" src="PTD-00.glb"></a-asset-item>
            </a-assets>

            <!-- ≈öWIAT≈ÅO (Mocne, in≈ºynierskie, ≈ºeby widzieƒá detale) -->
            <a-entity light="type: ambient; intensity: 0.8;"></a-entity>
            <a-entity light="type: directional; intensity: 1; castShadow: true;" position="-2 4 4"></a-entity>

            <!-- MODEL -->
            <!-- scale="1 1 1" - Skala rzeczywista -->
            <a-entity 
                id="target-model"
                gltf-model="#silos-asset" 
                position="0 1 -1.5" 
                rotation="0 0 0"
                shadow="receive: true">
            </a-entity>

            <!-- RIG (GRACZ) -->
            <!-- Position 0 0 0 jest kluczowe! Nie dodajemy sztucznej wysoko≈õci -->
            <a-entity id="rig" position="0 0 0">
                <a-entity camera position="0 0 0" look-controls="pointerLockEnabled: false"></a-entity>
                
                <!-- Prawa rƒôka - Sterowanie -->
                <a-entity 
                    oculus-touch-controls="hand: right"
                    remote-grab
                    model="true">
                </a-entity>

                <!-- Lewa rƒôka - Sterowanie (Opcjonalnie obie rƒôce mogƒÖ ≈Çapaƒá) -->
                <a-entity 
                    oculus-touch-controls="hand: left"
                    remote-grab
                    model="true">
                </a-entity>
            </a-entity>

        </a-scene>
    </div>

</body>
</html>
