<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PTD-00 Hybrid Viewer</title>

    <!-- 1. Silnik dla Mobile (Google Model Viewer) -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <!-- 2. Silnik dla Quest 3 (A-Frame) -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>

    <style>
        body { margin: 0; padding: 0; width: 100vw; height: 100vh; background-color: #f0f0f0; overflow: hidden; font-family: sans-serif; }
        
        /* Kontenery */
        #mobile-view { width: 100%; height: 100%; display: block; }
        #quest-view { width: 100%; height: 100%; display: none; z-index: 999; position: absolute; top: 0; left: 0; }

        /* Przyciski */
        .controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 1000; pointer-events: none; }
        .btn { pointer-events: auto; padding: 12px 25px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: transform 0.1s; }
        .btn:active { transform: scale(0.95); }
        .btn-quest { background: #8e44ad; color: white; display: flex; align-items: center; gap: 8px; }
        .btn-exit { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); color: white; display: none; z-index: 1001; }

        /* Ukrywanie przycisku Questa na ma≈Çych ekranach (opcjonalne) */
        @media (max-width: 600px) { .btn-quest { display: none; } }
    </style>

    <!-- SKRYPT: Obs≈Çuga chwytania (Grab) na Quest 3 -->
    <script>
        AFRAME.registerComponent('laser-grab', {
            init: function () {
                this.grabbedEl = null;
                this.el.addEventListener('raycaster-intersection', evt => {
                    this.intersectedEl = evt.detail.els[0];
                });
                this.el.addEventListener('raycaster-intersection-cleared', () => {
                    this.intersectedEl = null;
                });

                // Grip Down - Z≈Çap
                this.el.addEventListener('gripdown', () => {
                    if (this.intersectedEl && !this.grabbedEl) {
                        this.grabbedEl = this.intersectedEl;
                        this.grabbedEl.object3D.attach(this.el.object3D); // Do≈ÇƒÖcz do kontrolera
                        this.el.emit('grabbed');
                    }
                });

                // Grip Up - Pu≈õƒá
                this.el.addEventListener('gripup', () => {
                    if (this.grabbedEl) {
                        this.el.sceneEl.object3D.attach(this.grabbedEl.object3D); // Oddaj scenie
                        this.grabbedEl = null;
                        this.el.emit('released');
                    }
                });
            }
        });

        function startQuestMode() {
            document.getElementById('mobile-view').style.display = 'none';
            document.getElementById('quest-view').style.display = 'block';
            document.querySelector('.btn-exit').style.display = 'block';
            
            // Pr√≥ba wej≈õcia w AR/VR
            const scene = document.querySelector('a-scene');
            if(scene.enterVR) scene.enterVR();
        }

        function exitQuestMode() {
            const scene = document.querySelector('a-scene');
            if(scene.exitVR) scene.exitVR();
            
            document.getElementById('mobile-view').style.display = 'block';
            document.getElementById('quest-view').style.display = 'none';
            document.querySelector('.btn-exit').style.display = 'none';
        }
    </script>
</head>
<body>

    <!-- WIDOK 1: MOBILE (IOS/ANDROID) - Klasyczny Model-Viewer -->
    <div id="mobile-view">
        <!-- 
           Usuniƒôte "ar-placement", "interaction-prompt" itp. 
           Zostawione tylko to co niezbƒôdne dla iOS QuickLook i Android SceneViewer 
        -->
        <model-viewer 
            src="PTD-00.glb" 
            ios-src="PTD-00.usdz" 
            ar 
            ar-modes="webxr scene-viewer quick-look" 
            camera-controls 
            auto-rotate
            shadow-intensity="1">
            
            <button slot="ar-button" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; background: #007bff; color: white; border-radius: 30px; border: none; font-weight: bold;">
                üì¶ Zobacz w AR (Telefon)
            </button>
        </model-viewer>

        <!-- Przycisk przej≈õcia do trybu Quest -->
        <div class="controls">
            <button class="btn btn-quest" onclick="startQuestMode()">
                <span>ü•Ω</span> Otw√≥rz w Quest 3 (Mixed Reality)
            </button>
        </div>
    </div>

    <!-- WIDOK 2: META QUEST 3 (A-Frame) -->
    <div id="quest-view">
        <button class="btn btn-exit" onclick="exitQuestMode()">‚ùå Zamknij VR</button>
        
        <!-- 
            webxr: optionalFeatures: hit-test (pozwala na interakcje AR)
            background="color: transparent" -> KLUCZOWE DLA PASSTHROUGH (≈ºeby nie by≈Ço czarno)
        -->
        <a-scene 
            embedded 
            webxr="optionalFeatures: hit-test, local-floor; overlayElement: #quest-view"
            renderer="alpha: true; colorManagement: true;"
            background="color: transparent">

            <!-- Assets -->
            <a-assets>
                <a-asset-item id="silos" src="PTD-00.glb"></a-asset-item>
            </a-assets>

            <!-- O≈õwietlenie (wa≈ºne, ≈ºeby model nie by≈Ç p≈Çaski) -->
            <a-entity light="type: ambient; intensity: 0.5;"></a-entity>
            <a-entity light="type: directional; intensity: 1; castShadow: true;" position="-1 3 2"></a-entity>

            <!-- MODEL -->
            <!-- class="clickable" oznacza, ≈ºe laser na to reaguje -->
            <a-entity 
                id="target-model"
                gltf-model="#silos" 
                position="0 1 -2" 
                scale="1 1 1"
                class="clickable"
                shadow="receive: true">
            </a-entity>

            <!-- KONTROLERY -->
            <a-entity id="rig" position="0 0 0">
                <a-entity camera position="0 1.6 0" look-controls="pointerLockEnabled: false"></a-entity>

                <!-- Prawy kontroler: Laser + Grab -->
                <a-entity 
                    id="rhand"
                    oculus-touch-controls="hand: right"
                    laser-controls="hand: right"
                    raycaster="objects: .clickable; far: 10; showLine: true"
                    laser-grab>
                </a-entity>
                
                <!-- Lewy kontroler: Laser + Grab (opcjonalnie) -->
                <a-entity 
                    id="lhand"
                    oculus-touch-controls="hand: left"
                    laser-controls="hand: left"
                    raycaster="objects: .clickable; far: 10; showLine: true"
                    laser-grab>
                </a-entity>
            </a-entity>

        </a-scene>
    </div>

</body>
</html>
