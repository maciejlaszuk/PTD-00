<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTD-00 Universal Viewer (Mobile + VR)</title>
    
    <!-- 1. Biblioteka Model-Viewer (Dla Android/iOS/Desktop) -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <!-- 2. Biblioteka A-Frame (Tylko dla trybu Quest VR) -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    
    <style>
        body { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background-color: #f0f0f0; font-family: sans-serif; }
        
        /* Kontener dla Model-Viewer (Domy≈õlny) */
        #mobile-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; }
        
        /* Kontener dla VR (Ukryty domy≈õlnie) */
        #vr-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 20; display: none; }
        
        /* Przyciski */
        .custom-btn {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; z-index: 100; pointer-events: auto;
        }

        .btn {
            padding: 12px 24px; border-radius: 30px; border: none; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-size: 16px; display: flex; align-items: center; gap: 8px;
        }

        .btn-ar { background: #007bff; color: white; } /* Niebieski dla Mobile AR */
        .btn-vr { background: #8e44ad; color: white; } /* Fioletowy dla Quest VR */
        .btn-close-vr { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; z-index: 1000; display: none; }

        /* Ukryj przycisk VR na ma≈Çych telefonach (opcjonalne, ale czystsze) */
        @media (max-width: 600px) {
            .btn-vr { display: none; } 
        }
    </style>

    <!-- SKRYPT LOGIKI CHWYTANIA DLA QUESTA (GRAB) -->
    <script>
        // Rejestracja komponentu do chwytania obiekt√≥w w A-Frame
        AFRAME.registerComponent('simple-grab', {
            init: function () {
                this.el.addEventListener('triggerdown', this.onGrab.bind(this)); // Quest Trigger
                this.el.addEventListener('gripdown', this.onGrab.bind(this));    // Quest Grip (Boczny)
                this.el.addEventListener('triggerup', this.onRelease.bind(this));
                this.el.addEventListener('gripup', this.onRelease.bind(this));
                
                this.grabbedEl = null;
                this.tempParent = this.el; // Kontroler
            },
            onGrab: function (evt) {
                // Szukamy obiekt√≥w w zasiƒôgu (klasa .grabbable)
                // Uproszczona wersja: po prostu ≈Çapie model g≈Ç√≥wny, je≈õli jest blisko lub zdefiniowany
                const model = document.querySelector('#vr-model-entity');
                if (model) {
                    this.grabbedEl = model;
                    // Przyczep model do kontrolera
                    this.grabbedEl.object3D.attach(this.el.object3D);
                }
            },
            onRelease: function (evt) {
                if (this.grabbedEl) {
                    // Odczep model (wraca do sceny, ale zachowuje pozycjƒô w przestrzeni)
                    this.el.sceneEl.object3D.attach(this.grabbedEl.object3D);
                    this.grabbedEl = null;
                }
            }
        });

        // Funkcja prze≈ÇƒÖczania widok√≥w
        function enterQuestMode() {
            document.getElementById('mobile-container').style.display = 'none';
            document.getElementById('vr-container').style.display = 'block';
            document.querySelector('.btn-close-vr').style.display = 'block';
            
            // Wymu≈õ wej≈õcie w VR (je≈õli przeglƒÖdarka pozwoli, inaczej user klika ikonƒô gogli)
            const scene = document.querySelector('a-scene');
            if (scene.enterVR) {
                scene.enterVR();
            }
        }

        function exitQuestMode() {
            document.getElementById('mobile-container').style.display = 'block';
            document.getElementById('vr-container').style.display = 'none';
            document.querySelector('.btn-close-vr').style.display = 'none';
            
            const scene = document.querySelector('a-scene');
            scene.exitVR();
        }
    </script>
</head>
<body>

    <!-- 1. TRYB KLASYCZNY (Mobile / Desktop) -->
    <div id="mobile-container">
        <model-viewer 
            src="PTD-00.glb" 
            ios-src="PTD-00.usdz" 
            ar 
            ar-modes="scene-viewer quick-look" 
            camera-controls 
            auto-rotate
            shadow-intensity="1"
            touch-action="pan-y">
            
            <!-- Standardowy przycisk AR (dla iOS/Android) - Model Viewer obs≈Çuguje go sam -->
            <button slot="ar-button" class="btn btn-ar" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);">
                üì± Zobacz w AR (Telefon)
            </button>
        </model-viewer>

        <!-- Dodatkowy przycisk dla u≈ºytkownik√≥w Quest -->
        <div style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 100;">
            <button onclick="enterQuestMode()" class="btn btn-vr">
                ü•Ω Otw√≥rz w Quest 3 (Tryb Chwytania)
            </button>
        </div>
    </div>

    <!-- 2. TRYB VR (A-Frame dla Quest 3) -->
    <div id="vr-container">
        <button onclick="exitQuestMode()" class="btn btn-close-vr">‚ùå Wr√≥ƒá</button>

        <a-scene embedded renderer="colorManagement: true;">
            <a-assets>
                <a-asset-item id="model-ptd" src="PTD-00.glb"></a-asset-item>
            </a-assets>

            <!-- MODEL - Klasa .grabbable logicznie oznacza obiekt do ≈Çapania -->
            <a-entity 
                id="vr-model-entity"
                gltf-model="#model-ptd" 
                position="0 1 -1" 
                scale="1 1 1"
                shadow="receive: true">
            </a-entity>

            <!-- O≈öWIETLENIE -->
            <a-entity light="type: ambient; intensity: 0.6;"></a-entity>
            <a-entity light="type: directional; intensity: 1;" position="-1 2 1"></a-entity>

            <!-- RIG (GRACZ) + KONTROLERY Z FUNKCJƒÑ GRAB -->
            <a-entity id="rig" position="0 0 0">
                <a-entity camera position="0 1.6 0" look-controls="pointerLockEnabled: false"></a-entity>
                
                <!-- Lewa Rƒôka (z logikƒÖ chwytania) -->
                <a-entity 
                    oculus-touch-controls="hand: left" 
                    simple-grab 
                    model="true">
                </a-entity>
                
                <!-- Prawa Rƒôka (z logikƒÖ chwytania) -->
                <a-entity 
                    oculus-touch-controls="hand: right" 
                    simple-grab 
                    model="true" 
                    laser-controls="hand: right">
                </a-entity>
            </a-entity>
            
            <!-- T≈Ço VR -->
            <a-sky color="#ECECEC"></a-sky>
        </a-scene>
    </div>

</body>
</html>
